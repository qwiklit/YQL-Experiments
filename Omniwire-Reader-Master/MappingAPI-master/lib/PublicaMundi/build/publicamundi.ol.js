/* PublicaMundi Mapping API version 0.1.0 2015-11-19 */

!function(a,b){"use strict";"undefined"!=typeof b&&(b.define("PublicaMundi.OpenLayers"),b.OpenLayers.Framework="ol",b.registerFrameworkResolver(b.OpenLayers.Framework,function(){return b.isObject(ol)&&b.isFunction(ol.Map)?!0:!1}))}(window,PublicaMundi),ol.control.LayerSwitcher=function(a){var b=a||{},c=b.tipLabel?b.tipLabel:"Legend";this.mapListeners=[],this.hiddenClassName="ol-unselectable ol-control layer-switcher",this.shownClassName=this.hiddenClassName+" shown";var d=document.createElement("div");d.className=this.hiddenClassName;var e=document.createElement("button");e.setAttribute("title",c),d.appendChild(e),this.panel=document.createElement("div"),this.panel.className="panel",d.appendChild(this.panel);var f=this;d.onmouseover=function(a){f.showPanel()},e.onclick=function(a){f.showPanel()},d.onmouseout=function(a){a=a||window.event,d.contains(a.toElement)||f.hidePanel()},ol.control.Control.call(this,{element:d,target:b.target})},ol.inherits(ol.control.LayerSwitcher,ol.control.Control),ol.control.LayerSwitcher.prototype.showPanel=function(){this.element.className!=this.shownClassName&&(this.element.className=this.shownClassName,this.renderPanel())},ol.control.LayerSwitcher.prototype.hidePanel=function(){this.element.className!=this.hiddenClassName&&(this.element.className=this.hiddenClassName)},ol.control.LayerSwitcher.prototype.renderPanel=function(){for(this.ensureTopVisibleBaseLayerShown_();this.panel.firstChild;)this.panel.removeChild(this.panel.firstChild);var a=document.createElement("ul");this.panel.appendChild(a),this.renderLayers_(this.getMap(),a)},ol.control.LayerSwitcher.prototype.setMap=function(a){for(var b=0;b<this.mapListeners.length;b++)this.getMap().unByKey(this.mapListeners[b]);if(this.mapListeners.length=0,ol.control.Control.prototype.setMap.call(this,a),a){var c=this;this.mapListeners.push(a.on("pointerdown",function(){c.hidePanel()})),this.renderPanel()}},ol.control.LayerSwitcher.prototype.ensureTopVisibleBaseLayerShown_=function(){var a;ol.control.LayerSwitcher.forEachRecursive(this.getMap(),function(b,c,d){"base"===b.get("type")&&b.getVisible()&&(a=b)}),a&&this.setVisible_(a,!0)},ol.control.LayerSwitcher.prototype.setVisible_=function(a,b){var c=this.getMap();a.setVisible(b),b&&"base"===a.get("type")&&ol.control.LayerSwitcher.forEachRecursive(c,function(b,c,d){b!=a&&"base"===b.get("type")&&b.setVisible(!1)})},ol.control.LayerSwitcher.prototype.renderLayer_=function(a,b){var c=this,d=document.createElement("li"),e=a.get("title"),f=a.get("title").replace(/\s+/g,"-")+"_"+b,g=document.createElement("label");if(a.getLayers){d.className="group",g.innerHTML=e,d.appendChild(g);var h=document.createElement("ul");d.appendChild(h),this.renderLayers_(a,h)}else{var i=document.createElement("input");"base"===a.get("type")?(i.type="radio",i.name="base"):i.type="checkbox",i.id=f,i.checked=a.get("visible"),i.onchange=function(b){c.setVisible_(a,b.target.checked)},d.appendChild(i),g.htmlFor=f,g.innerHTML=e,d.appendChild(g)}return d},ol.control.LayerSwitcher.prototype.renderLayers_=function(a,b){for(var c,d=a.getLayers().getArray().slice().reverse(),e=0;e<d.length;e++)c=d[e],c.get("title")&&b.appendChild(this.renderLayer_(c,e))},ol.control.LayerSwitcher.forEachRecursive=function(a,b){a.getLayers().forEach(function(a,c,d){b(a,c,d),a.getLayers&&ol.control.LayerSwitcher.forEachRecursive(a,b)})},function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers"),b.OpenLayers.Map=b.Class(b.Map,{addOverlay:function(a){return popup=new c.Overlay({element:a}),this._map.addOverlay(popup),popup},getOverlayElement:function(a){return a.getElement()},setOverlayPosition:function(a,b){a.setPosition(b)},setExtent:function(a,b){if(null!==a){var d;"EPSG:4326"==b?(a[0]<-180&&(a[0]=-179),a[1]<-90&&(a[1]=-89),a[2]>180&&(a[2]=179),a[3]>90&&(a[3]=89),d=c.proj.transformExtent(a,"EPSG:4326","EPSG:3857")):d="EPSG:3857"==b?a:null,this._map.getView().fitExtent(d,this._map.getSize())}},initialize:function(a){if(b.Map.prototype.initialize.call(this,a),b.isClass("ol.Map")&&a instanceof c.Map?this._map=a:this._map=new c.Map({target:a.target,view:new c.View({projection:a.projection,center:a.center,zoom:a.zoom,maxZoom:a.maxZoom,minZoom:a.minZoom}),controls:c.control.defaults({rotate:!1}).extend([]),interactions:a.interactions,ol3Logo:!1}),a.layerControl&&this.setLayerControl(),this._listen(),this._clickHandlerMap=null,this._clickHandlerLayer=[],this._clickHandlerRegisteredLayers=[],this._map.on("click",function(a){}),"undefined"!=typeof a.layers&&b.isArray(a.layers))for(var d=0;d<a.layers.length;d++)this.createLayer(a.layers[d])},setCenter:function(a,c){b.isArray(a)?this._map.getView().setCenter(a):this._map.getView().setCenter([a,c])},getCenter:function(){return this._map.getView().getCenter()},setZoom:function(a){this._map.getView().setZoom(a)},getZoom:function(){return this._map.getView().getZoom()},getProjection:function(){return this._map.getView().getProjection().getCode()},getTarget:function(){return this._map.getTarget()},addLayer:function(a){this._map.addLayer(a.getLayer()),a.getOptions().fitToMap&&a.fitToMap();var d=b.helpers();if(b.isFunction(a.getOptions().click)&&(this._clickHandlerRegisteredLayers.push(a),this._clickHandlerLayer.push(a.getOptions().click),this._featureOverlay=new c.FeatureOverlay({map:this._map}),!b.isFunction(this._clickHandlerMap))){var e=this._clickHandlerRegisteredLayers,f=this._clickHandlerLayer,g=this._map,h=this;this._clickHandlerMap=function(a){var c=this._map.getEventPixel(a.originalEvent),i=[];g._highlight&&(h._featureOverlay.removeFeature(g._highlight),g._highlight=void 0);for(var j=function(a,c){if(c===e[k].getLayer()&&c.get("visible")===!0){var f=e[k],j=f._style,l=null;b.isFunction(j.highlight)?h._featureOverlay.setStyle(j.highlight):(l=d._transformStyle(j.highlight),h._featureOverlay.setStyle(l)),g._highlight?g._highlight!==a&&(h._featureOverlay.removeFeature(g._highlight),g._highlight=a,h._featureOverlay.addFeature(a)):(g._highlight=a,h._featureOverlay.addFeature(a));for(var m={},n=a.getKeys(),o=a.getGeometryName(),p=0;p<n.length;p++)n[p]!==o&&(m[n[p]]=a.get(n[p]));i.push(m)}},k=0;k<e.length;k++)i=[],this._map.forEachFeatureAtPixel(c,j),i.length>0&&f[k](i,a.coordinate)},this._map.on("singleclick",this._clickHandlerMap,this)}},removeLayer:function(a){if(a){this._map.removeLayer(a.getLayer());for(var b=0;b<this._layers.length;b++)if(this._layers[b]==a){this._layers.splice(b,1);break}}},setLayerControl:function(a){return this._control=new c.control.LayerSwitcher,this._map.getControls().extend([this._control]),this._control},_setViewBox:function(){var a=this.getExtent()[0]+","+this.getExtent()[1]+","+this.getExtent()[2]+","+this.getExtent()[3];this._viewbox=a},getExtent:function(){return this._map.getView().calculateExtent(this._map.getSize())},_listen:function(){var a=this;this._map.on("moveend",function(){a._setViewBox()})}}),b.locator.register("PublicaMundi.Map",b.OpenLayers.Map))}(window,window.PublicaMundi,ol),function(a,b){"undefined"!=typeof b&&(b.define("PublicaMundi.OpenLayers.Helpers"),b.OpenLayers.Helpers=b.Class(b.Helpers,{initialize:function(){},_getDefaultStyle:function(a,b){if(!a&&!b)return{};var c={};return c.color=a.color||b.color||"rgba(0,255,0)",c.opacity=a.opacity||b.opacity||1,c.fillColor=a.fillColor||b.fillColor||"rgba(255,255,0)",c.fillOpacity=a.fillOpacity||b.fillOpacity||1,c.weight=a.weight||b.weight||1,c.radius=a.radius||b.radius||6,c},_transformStyle:function(a){if(!a)return{};var b={};return b.color=this._hexToRgba(a.color,a.opacity),b.fillColor=this._hexToRgba(a.fillColor,a.fillOpacity),b.weight=a.weight,b.radius=a.radius,new ol.style.Style({stroke:new ol.style.Stroke({color:b.color,width:b.weight}),fill:new ol.style.Fill({color:b.fillColor}),image:new ol.style.Circle({radius:b.radius,stroke:new ol.style.Stroke({color:b.color,width:b.weight}),fill:new ol.style.Fill({color:b.fillColor})})})},_hexToRgba:function(a,b){var c=a;return a&&0===a.indexOf("#")&&(c=ol.color.asArray(c),c=c.slice(),c[3]=b,c=ol.color.asString(c)),c}}),b.locator.register("PublicaMundi.Helpers",b.OpenLayers.Helpers),b.helpers=function(){return b.locator.create("PublicaMundi.Helpers")})}(window,PublicaMundi),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.WMS=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a),this._map=null,this._type=null,this._layer=new c.layer.Tile({title:a.title,type:a.switcher,visible:a.visible,source:new c.source.TileWMS({url:a.url,params:a.params})})},onLayerLoad:function(a){this._layer.on("change:visible",function(b){b.oldValue===!1&&a.call()})},fitToMap:function(){var a=this,c=this._options;if(null!==a._extent)a._layer.once("postcompose",function(){a.getMap().setExtent(a._extent,"EPSG:4326")});else{var d=b.parser(),e=c.url+"?service=WMS&request=GetCapabilities";$.ajax({url:e,success:function(b){var e=d.parseWMS(b),f=e.Layer;for(var g in f){var h=f[g];if(h.Name==c.params.layers)return a._extent=h.EX_GeographicBoundingBox,a._layer.once("postcompose",function(){a.getMap().setExtent(a._extent,"EPSG:4326")}),!1}}})}}}),b.registry.registerLayerType({layer:b.LayerType.WMS,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.WMS",factory:b.OpenLayers.Layer.WMS}))}(window,window.PublicaMundi,ol),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.WFS=b.Class(b.Layer,{update:function(){},initialize:function(a){b.Layer.prototype.initialize.call(this,a),this._map=null,this._type=null,a.style=a.style||{normal:{},highlight:{}},a.style.normal=a.style.normal||{},a.style.highlight=a.style.highlight||{};var d=this._style.normal,e=b.helpers();b.isFunction(a.style.normal)?(this._style.normal=a.style.normal,d=this._style.normal):(this._style.normal=e._getDefaultStyle(a.style.normal,this._style.normal),d=e._transformStyle(this._style.normal)),b.isFunction(a.style.highlight)?this._style.highlight=a.style.highlight:this._style.highlight=e._getDefaultStyle(a.style.highlight,this._style.normal);var f,g=a.params.version,h=a.params.maxFeatures,i=a.params.format||"json";"gml"==i&&(i="gml2"),"json"==i?f=new c.format.GeoJSON:"gml32"==i||"gml31"==i||"gml3"==i?f=new c.format.WFS({gmlFormat:new c.format.GML3,extractAttributes:!0,resFactor:1}):"gml2"==i&&(f=new c.format.WFS({gmlFormat:new c.format.GML2}));var j=a.params.projection||"EPSG:3857";"EPSG:900913"==j?j="EPSG:3857":"EPSG:26713"==j&&(j="EPSG:3857");var k=a.params.layers,l=new c.source.Vector({format:f,projection:j,strategy:c.loadingstrategy.tile(new c.tilegrid.XYZ({})),loader:function(b,c,d){var e={service:"WFS",request:"GetFeature",typename:k,srsname:j,outputFormat:i,bbox:b.join(",")+",EPSG:3857",version:g},f="maxFeatures";"2.0.0"===g&&(f="count"),e[f]=h,$.ajax({type:"GET",url:a.url,data:e,async:!0,beforeSend:function(){},complete:function(){},success:function(a){m(a),$.event.trigger({type:"layerLoaded"})},failure:function(a){console.log("response"),console.log(a)}})}}),m=function(a){l.addFeatures(f.readFeatures(a))};this._layer=new c.layer.Vector({title:a.title,type:a.switcher,source:l,visible:a.visible,projection:j,style:d})},fitToMap:function(){var a=this,c=this._options;if(null!==a._extent)a._layer.once("postcompose",function(){a.getMap().setExtent(a._extent,"EPSG:4326")});else{var d=b.parser(),e=c.url+"?service=WFS&request=GetCapabilities";$.ajax({url:e,success:function(b){var e=d.parseWFS(b),f=e.Layer;for(var g in f){var h=f[g];if(h.Name==c.params.layers)return a._extent=h.WGS84BoundingBox,a._layer.once("postcompose",function(){a.getMap().setExtent(a._extent,"EPSG:4326")}),!1}}})}}}),b.registry.registerLayerType({layer:b.LayerType.WFS,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.WFS",factory:b.OpenLayers.Layer.WFS}))}(window,window.PublicaMundi,ol),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.Tile=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a);var d=[];if(a.url.indexOf("{s}")<0)d.push(a.url);else{var e=a.subdomains||"abc";b.isArray(e)||(e=e.split(""));for(var f=0;f<e.length;f++)d.push(a.url.replace("{s}",e[f]))}this._layer=new c.layer.Tile({title:a.title,type:a.switcher||"base",source:new c.source.XYZ({urls:d})})}}),b.registry.registerLayerType({layer:b.LayerType.TILE,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.Tile",factory:b.OpenLayers.Layer.Tile}))}(window,window.PublicaMundi,ol),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.KML=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a),a.style=a.style||{normal:{},highlight:{}},a.style.normal=a.style.normal||{},a.style.highlight=a.style.highlight||{};var d=this._style.normal,e=b.helpers();b.isFunction(a.style.normal)?(this._style.normal=a.style.normal,d=this._style.normal):(this._style.normal=e._getDefaultStyle(a.style.normal,this._style.normal),d=e._transformStyle(this._style.normal)),b.isFunction(a.style.highlight)?this._style.highlight=a.style.highlight:this._style.highlight=e._getDefaultStyle(a.style.highlight,this._style.normal),this._layer=new c.layer.Vector({title:a.title,type:a.switcher,visible:a.visible,source:new c.source.Vector({projection:a.projection,format:new c.format.KML({extractStyles:!1}),url:a.url}),style:d})},fitToMap:function(){var a=this;this._layer.once("postcompose",function(){a._extent=this.getSource().getExtent(),a.getMap().setExtent(a._extent,"EPSG:3857")})}}),b.registry.registerLayerType({layer:b.LayerType.KML,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.KML",factory:b.OpenLayers.Layer.KML}),b.isDefined(b.Map)&&(b.Map.prototype.KML=function(a){return a.type=b.LayerType.KML,this.createLayer(a)}))}(window,window.PublicaMundi,ol),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.GML=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a);var d=a.projection?a.projection:"EPSG:3857";"EPSG:900913"==d?d="EPSG:3857":"EPSG:26713"==d&&(d="EPSG:3857");var e=new c.format.WFS({gmlFormat:new c.format.GML3,extractAttributes:"False"}),f=new c.source.ServerVector({format:e,projection:d,loader:function(b,c,d){$.ajax({type:"GET",url:a.url,success:function(a){g(a)},failure:function(a){}})}});console.log("vectorSource"),console.log(f),this._layer=new c.layer.Vector({title:a.title,type:a.switcher,source:f,visible:!0,projection:d});var g=function(a){f.addFeatures(f.readFeatures(a))}},fitToMap:function(){var a=this;this._layer.once("postcompose",function(){a._extent=this.getSource().getExtent(),a.getMap().setExtent(a._extent,"EPSG:3857")})}}),b.registry.registerLayerType({layer:b.LayerType.GML,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.GML",factory:b.OpenLayers.Layer.GML}),b.isDefined(b.Map)&&(b.Map.prototype.GML=function(a){return a.type=b.LayerType.GML,this.createLayer(a)}))}(window,window.PublicaMundi,ol),function(a,b,c){"undefined"!=typeof b&&"undefined"!=typeof c&&(b.define("PublicaMundi.OpenLayers.Layer"),b.OpenLayers.Layer.GeoJson=b.Class(b.Layer,{initialize:function(a){b.Layer.prototype.initialize.call(this,a),a.style=a.style||{normal:{},highlight:{}},a.style.normal=a.style.normal||{},a.style.highlight=a.style.highlight||{};var d=this._style.normal,e=b.helpers();b.isFunction(a.style.normal)?(this._style.normal=a.style.normal,d=this._style.normal):(this._style.normal=e._getDefaultStyle(a.style.normal,this._style.normal),d=e._transformStyle(this._style.normal)),b.isFunction(a.style.highlight)?this._style.highlight=a.style.highlight:this._style.highlight=e._getDefaultStyle(a.style.highlight,this._style.normal);var f=null;if(a.url)f=new c.source.Vector({projection:a.projection,url:a.url});else if(a.text){var g=new c.format.GeoJSON,h=g.readFeatures(JSON.parse(a.text),{dataProjection:a.projection,featureProjection:b.Maps.CRS.Mercator});f=new c.source.GeoJSON({projection:a.projection}),f.addFeatures(h)}else if(a.data){var g=new c.format.GeoJSON,h=g.readFeatures(a.data,{dataProjection:a.projection,featureProjection:"EPSG:3857"});f=new c.source.Vector({projection:a.projection}),f.addFeatures(h)}this._layer=new c.layer.Vector({title:a.title,type:a.switcher,visible:a.visible,source:f,style:d})},fitToMap:function(){var a=this;this._layer.once("postcompose",function(){a._extent=this.getSource().getExtent(),a.getMap().setExtent(a._extent,"EPSG:3857")})}}),b.registry.registerLayerType({layer:b.LayerType.GeoJSON,framework:b.OpenLayers.Framework,type:"PublicaMundi.Layer.GeoJson",factory:b.OpenLayers.Layer.GeoJson}),b.isDefined(b.Map)&&(b.Map.prototype.geoJSON=function(a){return a.type=b.LayerType.GeoJSON,this.createLayer(a)}))}(window,window.PublicaMundi,ol);
//# sourceMappingURL=publicamundi.ol.js.map